openapi: 3.0.3
info:
  title: RAG Retrieval API
  description: Semantic search API for book content retrieval
  version: 1.0.0
servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /health:
    get:
      summary: Health Check
      description: Returns service health status including dependency connectivity
      operationId: health_check
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                qdrant: true
                postgres: true
        "503":
          description: Service degraded or unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: degraded
                qdrant: true
                postgres: false

  /search:
    post:
      summary: Semantic Search
      description: Search book content using natural language queries
      operationId: semantic_search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchRequest"
            example:
              query: "What is physical AI?"
              top_k: 5
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
              example:
                query: "What is physical AI?"
                results:
                  - chunk_id: "doc-001-0001"
                    snippet: "Physical AI represents a fundamental shift..."
                    source_path: "docs/chapter-1/index.md"
                    slug: "chapter-1-index"
                    title: "Introduction to Physical AI"
                    score: 0.87
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: validation_error
                message: "Query cannot be empty"
        "502":
          description: Upstream service error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: upstream_error
                message: "Failed to generate query embedding"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: service_unavailable
                message: "Vector store is unreachable"

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 500
          description: Natural language search query
        top_k:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
          description: Number of results to return

    SearchResult:
      type: object
      required:
        - chunk_id
        - snippet
        - source_path
        - slug
        - score
      properties:
        chunk_id:
          type: string
          description: Unique chunk identifier
        snippet:
          type: string
          description: Text content of the chunk
        source_path:
          type: string
          description: Source file path
        slug:
          type: string
          description: URL-friendly identifier
        title:
          type: string
          nullable: true
          description: Document title
        score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Relevance score (0-1)

    SearchResponse:
      type: object
      required:
        - query
        - results
      properties:
        query:
          type: string
          description: Original search query
        results:
          type: array
          items:
            $ref: "#/components/schemas/SearchResult"
          description: Ranked search results

    HealthResponse:
      type: object
      required:
        - status
        - qdrant
        - postgres
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
          description: Overall service status
        qdrant:
          type: boolean
          description: Qdrant connectivity status
        postgres:
          type: boolean
          description: Postgres connectivity status

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          enum: [validation_error, upstream_error, service_unavailable, internal_error]
          description: Error type identifier
        message:
          type: string
          description: Human-readable error message
